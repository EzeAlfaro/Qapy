<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BloomWatch ‚Äì NASA Space Apps 2025</title>
  <meta name="description" content="BloomWatch: Monitoreo satelital de floraciones (HLSS30/Sentinel-2) con Google Earth Engine. MRBI, unmixing espectral, series mensuales, anomal√≠as y validaci√≥n ciudadana." />
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-green:#00d4aa;--primary-yellow:#ffd23f;--orange-bloom:#ff6b47; 
      --blue-accent:#4f46e5;--dark-blue:#0f172a;--light-gray:#f8fafc;--white:#ffffff;
      --purple-accent:#7c3aed;--pink-accent:#ec4899;--cyan-accent:#06b6d4;
      --rose-accent:#f43f5e;--lime-accent:#65a30d;--indigo-accent:#4338ca;
      --emerald-accent:#10b981;--amber-accent:#f59e0b;--violet-accent:#8b5cf6;
      --shadow:0 25px 50px rgba(15,23,42,.15);--shadow-hover:0 35px 70px rgba(15,23,42,.25);
      --shadow-colored:0 20px 40px rgba(0,212,170,.2);
      --border-glow:0 0 20px rgba(0,212,170,.3);
      --text-glow:0 0 30px rgba(0,212,170,.4);
    }
    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      line-height:1.6;color:var(--white);background:var(--dark-blue);
      min-height:100vh;overflow-x:hidden;position:relative;
    }
    body::before{
      content:'';position:fixed;top:0;left:0;width:100%;height:100%;
      background:
        radial-gradient(circle at 15% 85%,rgba(0,212,170,.08) 0%,transparent 40%),
        radial-gradient(circle at 85% 15%,rgba(79,70,229,.08) 0%,transparent 40%),
        radial-gradient(circle at 45% 45%,rgba(124,58,237,.06) 0%,transparent 40%),
        radial-gradient(circle at 75% 25%,rgba(255,107,71,.06) 0%,transparent 40%),
        radial-gradient(circle at 25% 75%,rgba(255,210,63,.05) 0%,transparent 40%);
      z-index:-1;animation:backgroundShift 30s ease-in-out infinite;
    }
    @keyframes backgroundShift{0%,100%{opacity:1}50%{opacity:0.8}}
    .container{max-width:1400px;margin:0 auto;padding:0 20px}
    header{
      background:rgba(15,23,42,.98);backdrop-filter:blur(25px);border-bottom:1px solid rgba(0,212,170,.2);
      padding:1.5rem 0;position:sticky;top:0;z-index:1000;transition:all 0.3s ease;
      box-shadow:0 8px 32px rgba(15,23,42,.3);
    }
    .header-content{display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:15px;font-size:1.6rem;font-weight:800}
    .logo img{height:50px;width:auto;filter:drop-shadow(var(--border-glow))}
    .logo-text{
      color:var(--primary-green);font-weight:900;text-shadow:var(--text-glow);
      letter-spacing:-0.02em;
    }
    .nasa-badge{
      background:var(--blue-accent);color:var(--white);padding:12px 20px;
      border-radius:30px;font-weight:700;text-transform:uppercase;font-size:.9rem;
      letter-spacing:1px;white-space:nowrap;box-shadow:var(--shadow-colored);
      border:1px solid rgba(0,212,170,.3);position:relative;overflow:hidden;
    }
    .nasa-badge::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
      transition:left 0.5s ease;
    }
    .nasa-badge:hover::before{left:100%}
    .lang-toggle{display:flex;gap:10px}
    .lang-btn{
      border:2px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);
      padding:8px 16px;border-radius:25px;cursor:pointer;font-weight:600;
      color:var(--white);transition:all 0.3s ease;backdrop-filter:blur(10px);
    }
    .lang-btn.active{
      background:var(--primary-green);border-color:var(--primary-green);
      box-shadow:var(--border-glow);color:var(--dark-blue);
    }
    .lang-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .space-apps-banner{
      display:flex;justify-content:center;align-items:center;
      margin:2rem 0;padding:1.5rem;background:rgba(15,23,42,.6);
      backdrop-filter:blur(20px);border-radius:25px;border:1px solid rgba(0,212,170,.2);
      box-shadow:var(--shadow-colored);position:relative;overflow:hidden;
    }
    .space-apps-banner::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,rgba(0,212,170,.1) 60deg,transparent 120deg);
      z-index:-1;animation:rotate 20s linear infinite;
    }
    @keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .space-apps-banner img{
      max-width:100%;height:auto;max-height:120px;
      filter:drop-shadow(var(--border-glow));transition:transform 0.3s ease;
    }
    .space-apps-banner:hover img{transform:scale(1.05)}
    .hero{
      background:rgba(15,23,42,.4);backdrop-filter:blur(25px);border:1px solid rgba(0,212,170,.3);
      padding:5rem 2rem;margin-top:2rem;border-radius:35px;box-shadow:var(--shadow-hover);
      position:relative;overflow:hidden;text-align:center;
    }
    .hero::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 45deg at 30% 30%,transparent 0deg,rgba(0,212,170,.05) 90deg,transparent 180deg);
      z-index:-1;animation:rotate 30s linear infinite reverse;
    }
    .hero h1{
      font-size:clamp(2.5rem,5vw,4rem);margin-bottom:1rem;font-weight:900;
      color:var(--white);text-shadow:var(--text-glow);
      letter-spacing:-0.02em;line-height:1.1;
    }
    .gradient{
      color:var(--primary-green);text-shadow:var(--text-glow);
      position:relative;
    }
    .gradient::after{
      content:'';position:absolute;bottom:-2px;left:0;width:100%;height:3px;
      background:var(--primary-green);border-radius:2px;
      box-shadow:var(--border-glow);
    }
    .hero-subtitle{
      text-align:center;font-size:1.3rem;color:rgba(255,255,255,.8);
      margin-bottom:2rem;font-weight:500;
    }
    .section{
      background:rgba(15,23,42,.3);backdrop-filter:blur(25px);border:1px solid rgba(0,212,170,.2);
      padding:3.5rem 2.5rem;margin:2.5rem auto;border-radius:30px;box-shadow:var(--shadow-hover);
      position:relative;overflow:hidden;
    }
    .section::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 90deg at 70% 20%,transparent 0deg,rgba(0,212,170,.03) 120deg,transparent 240deg);
      z-index:-1;animation:rotate 40s linear infinite;
    }
    .section-title{
      font-size:2.5rem;margin-bottom:1.5rem;position:relative;padding-left:50px;
      color:var(--white);font-weight:800;letter-spacing:-0.02em;
    }
    .section-title::before{
      content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);
      width:8px;height:40px;background:var(--primary-green);
      border-radius:4px;box-shadow:var(--border-glow);
    }
    .global-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:2rem}
    .location-card{
      background:rgba(15,23,42,.5);backdrop-filter:blur(20px);border:1px solid rgba(0,212,170,.3);
      padding:2.5rem 2rem;border-radius:25px;text-align:center;transition:all 0.4s ease;
      position:relative;overflow:hidden;box-shadow:var(--shadow);
    }
    .location-card::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 180deg at 50% 50%,transparent 0deg,rgba(0,212,170,.05) 60deg,transparent 120deg);
      z-index:-1;opacity:0;transition:opacity 0.3s ease;
    }
    .location-card:hover{
      transform:translateY(-10px) scale(1.02);border-color:var(--primary-green);
      box-shadow:var(--shadow-colored);
    }
    .location-card:hover::before{opacity:1}
    .location-card h4{color:var(--white);font-size:1.3rem;font-weight:700;margin-bottom:0.5rem}
    .location-card p{color:rgba(255,255,255,.7);font-size:1rem;margin-bottom:0.5rem}
    .flag{font-size:2.5rem;margin-bottom:1rem;filter:drop-shadow(0 0 10px rgba(255,255,255,.3))}
    .tech-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem;margin-top:2rem}
    .tech-card{
      background:rgba(15,23,42,.4);backdrop-filter:blur(20px);border:1px solid rgba(0,212,170,.25);
      padding:2.5rem;border-radius:25px;border-left:4px solid var(--primary-green);
      transition:all 0.4s ease;position:relative;overflow:hidden;box-shadow:var(--shadow);
    }
    .tech-card::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 270deg at 20% 80%,transparent 0deg,rgba(0,212,170,.04) 90deg,transparent 180deg);
      z-index:-1;opacity:0;transition:opacity 0.3s ease;
    }
    .tech-card:hover{
      transform:translateY(-8px);border-color:var(--primary-green);
      box-shadow:var(--shadow-colored);
    }
    .tech-card:hover::before{opacity:1}
    .tech-card h3{color:var(--white);font-size:1.4rem;margin-bottom:1rem;font-weight:700}
    .tech-card p{color:rgba(255,255,255,.8);line-height:1.6;margin-bottom:0.8rem}
    .indices-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-top:2rem}
    .index-box{
      border:2px solid var(--primary-green);border-radius:20px;padding:2rem;
      text-align:center;transition:all 0.4s ease;background:rgba(15,23,42,.4);
      backdrop-filter:blur(20px);position:relative;overflow:hidden;box-shadow:var(--shadow);
    }
    .index-box::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,rgba(0,212,170,.06) 120deg,transparent 240deg);
      z-index:-1;opacity:0;transition:opacity 0.3s ease;
    }
    .index-box:hover{
      transform:translateY(-8px) scale(1.05);border-color:var(--primary-green);
      box-shadow:var(--shadow-colored);
    }
    .index-box:hover::before{opacity:1}
    .index-box h4{color:var(--white);font-size:1.2rem;margin-bottom:0.8rem;font-weight:700}
    .index-box p{color:rgba(255,255,255,.7);font-size:0.9rem}
    .gee-section{
      background:rgba(15,23,42,.6);color:var(--white);padding:4rem 2.5rem;
      border-radius:35px;margin:2.5rem auto;position:relative;overflow:hidden;
      box-shadow:var(--shadow-hover);border:1px solid rgba(0,212,170,.3);
    }
    .gee-section::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,rgba(0,212,170,.08) 60deg,rgba(79,70,229,.05) 120deg,transparent 180deg);
      z-index:0;animation:rotate 25s linear infinite;
    }
    .gee-title{
      text-align:center;margin-bottom:1.5rem;font-size:2.5rem;
      font-weight:900;text-shadow:var(--text-glow);
      position:relative;z-index:1;color:var(--white);
    }
    .iframe-container{
      background:rgba(15,23,42,.7);backdrop-filter:blur(25px);
      padding:20px;border-radius:25px;margin-top:2rem;
      box-shadow:var(--shadow-hover);border:1px solid rgba(0,212,170,.3);
      position:relative;z-index:1;
    }
    .mrbi-legend{
      background:rgba(15,23,42,.8);backdrop-filter:blur(20px);
      padding:2rem;border-radius:20px;display:inline-block;
      margin:2rem auto;border:1px solid rgba(0,212,170,.3);
      position:relative;z-index:1;box-shadow:var(--shadow);
    }
    .legend-items{display:flex;gap:1rem;align-items:center}
    .legend-item{display:flex;gap:.35rem;align-items:center}
    .legend-color{width:26px;height:18px;border-radius:3px}
    .features-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:2rem}
    .feature-item{
      background:rgba(15,23,42,.5);backdrop-filter:blur(20px);
      padding:2rem;border-radius:20px;border:1px solid rgba(0,212,170,.3);
      transition:all 0.4s ease;position:relative;overflow:hidden;box-shadow:var(--shadow);
    }
    .feature-item::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 45deg at 80% 20%,transparent 0deg,rgba(0,212,170,.04) 90deg,transparent 180deg);
      z-index:-1;opacity:0;transition:opacity 0.3s ease;
    }
    .feature-item:hover{
      transform:translateY(-5px);border-color:var(--primary-green);
      box-shadow:var(--shadow-colored);
    }
    .feature-item:hover::before{opacity:1}
    .feature-item h4{color:var(--white);font-size:1.1rem;font-weight:600}
    .cta-section{
      background:rgba(15,23,42,.6);color:var(--white);padding:4rem 2.5rem;
      border-radius:35px;text-align:center;position:relative;overflow:hidden;
      box-shadow:var(--shadow-hover);border:1px solid rgba(0,212,170,.3);
    }
    .cta-section::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,rgba(0,212,170,.06) 60deg,rgba(255,107,71,.04) 120deg,transparent 180deg);
      z-index:0;animation:rotate 35s linear infinite reverse;
    }
    .cta-title{font-size:2.5rem;font-weight:900;margin-bottom:1rem;position:relative;z-index:1;color:var(--white)}
    .cta-text{font-size:1.2rem;margin-bottom:2rem;opacity:0.9;position:relative;z-index:1}
    .cta-button{
      display:inline-block;background:var(--primary-green);color:var(--dark-blue);
      padding:15px 30px;border-radius:50px;text-decoration:none;font-weight:700;
      margin:0.5rem;transition:all 0.4s ease;border:2px solid transparent;
      position:relative;z-index:1;box-shadow:var(--shadow-colored);
    }
    .cta-button:hover{
      transform:translateY(-3px);background:var(--white);color:var(--dark-blue);
      box-shadow:var(--shadow-hover);
    }
    .impact-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-top:2rem}
    .impact-item{
      display:flex;gap:15px;padding:2rem;background:rgba(15,23,42,.5);
      backdrop-filter:blur(20px);border-radius:25px;border:1px solid rgba(0,212,170,.3);
      transition:all 0.4s ease;position:relative;overflow:hidden;box-shadow:var(--shadow);
    }
    .impact-item::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 135deg at 30% 70%,transparent 0deg,rgba(0,212,170,.04) 90deg,transparent 180deg);
      z-index:-1;opacity:0;transition:opacity 0.3s ease;
    }
    .impact-item:hover{
      transform:translateY(-8px);border-color:var(--primary-green);
      box-shadow:var(--shadow-colored);
    }
    .impact-item:hover::before{opacity:1}
    .impact-item span{font-size:2rem;filter:drop-shadow(0 0 10px rgba(255,255,255,.3))}
    .impact-item h4{color:var(--white);font-size:1.2rem;margin-bottom:0.5rem;font-weight:700}
    .impact-item p{color:rgba(255,255,255,.8);font-size:0.95rem;line-height:1.5}
    footer{
      background:rgba(15,23,42,.95);color:var(--white);padding:4rem 0;
      margin-top:3rem;border-radius:35px 35px 0 0;position:relative;overflow:hidden;
      border-top:1px solid rgba(0,212,170,.3);
    }
    footer::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:conic-gradient(from 0deg at 50% 0%,transparent 0deg,rgba(0,212,170,.05) 60deg,transparent 120deg);
      z-index:0;animation:rotate 50s linear infinite;
    }
    .footer-content{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:2rem;margin-bottom:2rem;position:relative;z-index:1;
    }
    .footer-section h4{
      color:var(--primary-green);margin-bottom:1rem;font-size:1.3rem;
      font-weight:700;text-shadow:var(--text-glow);
    }
    .footer-section ul{list-style:none}
    .footer-section li{
      margin-bottom:0.6rem;opacity:0.8;transition:opacity 0.3s ease;
      color:rgba(255,255,255,.9);
    }
    .footer-section li:hover{opacity:1;color:var(--primary-green)}
    .footer-bottom{
      text-align:center;border-top:1px solid rgba(255,255,255,.2);
      padding-top:2rem;opacity:0.8;position:relative;z-index:1;
      font-size:1rem;
    }
    /* Accordion (Manual) */
    .accordion{display:grid;gap:1rem;margin-top:1.5rem}
    .acc-item{border:1px solid rgba(0,212,170,.25);border-left:4px solid var(--primary-green);border-radius:16px;background:rgba(15,23,42,.45);backdrop-filter:blur(16px);box-shadow:var(--shadow)}
    .acc-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;cursor:pointer}
    .acc-title{font-weight:700}
    .acc-icon{transition:transform .25s ease}
    .acc-content{max-height:0;overflow:hidden;transition:max-height .35s ease,padding .35s ease;padding:0 1.25rem}
    .acc-content.open{padding:0 1.25rem 1rem 1.25rem}
    .acc-item.open .acc-icon{transform:rotate(90deg)}
    /* Quick actions (open/copy GEE link) */
    .gee-quick-actions{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-top:12px}
    .gee-quick-note{font-size:.95rem;text-align:center;opacity:.85;margin-top:.5rem}
    /* Demo alert */
    .demo-alert{
      margin:10px auto 0;max-width:900px;background:rgba(255,210,63,.12);
      border:1px solid rgba(255,210,63,.45);color:#fff;padding:14px 16px;border-radius:14px;
      box-shadow:var(--shadow);
    }
    .demo-alert strong{color:#ffd23f}
    @media(max-width:768px){
      .hero{padding:2.5rem 1.5rem}
      .section{padding:2rem 1.5rem}
      .gee-section{padding:2rem 1.5rem}
      .iframe-container iframe{height:60vh!important}
      .header-content{justify-content:center;flex-direction:column;gap:15px}
      .logo{flex-direction:column;text-align:center}
      .logo img{height:40px}
      .section-title{font-size:2rem;padding-left:40px}
      .section-title::before{font-size:1.5rem}
      .hero h1{font-size:2rem}
      .hero-subtitle{font-size:1.1rem}
      .cta-title{font-size:2rem}
      .cta-text{font-size:1rem}
    }
    @media(max-width:480px){
      .hero{padding:2rem 1rem}
      .section{padding:1.5rem 1rem}
      .gee-section{padding:1.5rem 1rem}
      .global-grid{grid-template-columns:1fr}
      .tech-grid{grid-template-columns:1fr}
      .indices-grid{grid-template-columns:1fr}
      .features-grid{grid-template-columns:1fr}
      .impact-list{grid-template-columns:1fr}
      .hero h1{font-size:1.8rem}
      .section-title{font-size:1.8rem}
      .cta-title{font-size:1.8rem}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <img src="qapy_capybara_logo_vector_1024 (1).png" alt="Qapy Logo" />
          <span class="logo-text" data-i18n="brand">BloomWatch Global</span>
        </div>
        <div class="lang-toggle" aria-label="Language switch">
          <button class="lang-btn active" data-lang="es">ES</button>
          <button class="lang-btn" data-lang="en">EN</button>
        </div>
        <div class="nasa-badge">NASA Space Apps 2025</div>
      </div>
    </div>
  </header>

  <!-- Space Apps Banner -->
  <div class="container">
    <div class="space-apps-banner">
      <img src="Space Apps Logo on blue.png" alt="NASA Space Apps Challenge" />
    </div>
  </div>

  <!-- Hero -->
  <div class="container">
    <section class="hero">
      <h1 data-i18n="hero_title">BloomWatch: <span class="gradient">Detecci√≥n de floraciones desde el espacio</span> üöÄ</h1>
      <p class="hero-subtitle" data-i18n="hero_sub">
        Monitoreo satelital de floraciones con datos NASA/ESA ¬∑ actualizaci√≥n reciente (30/90 d√≠as)
      </p>
    </section>
  </div>

  <!-- Global Coverage -->
  <div class="container">
    <section class="section">
      <h2 class="section-title" data-i18n="cov_title">Cobertura Global de Monitoreo</h2>
      <p style="margin-bottom:1rem" data-i18n="cov_text">
        Nuestro sistema monitorea floraciones espectaculares en diversos biomas. Con m√∫ltiples sat√©lites y an√°lisis espectral, detectamos y cuantificamos eventos con precisi√≥n.
      </p>
      <div class="global-grid">
        <div class="location-card">
          <div class="flag">üá¶üá∫</div>
          <h4>Western Australia</h4>
          <p>Mid West Region</p>
          <small style="color:var(--primary-green);font-weight:700" data-i18n="recommended">‚≠ê Recomendado</small>
        </div>
        <div class="location-card"><div class="flag">üáøüá¶</div><h4>Namaqualand</h4><p>South Africa</p></div>
        <div class="location-card"><div class="flag">üá∫üá∏</div><h4>Carrizo Plain</h4><p>California</p></div>
        <div class="location-card"><div class="flag">üá™üá∏</div><h4>Castilla-La Mancha</h4><p>Espa√±a</p></div>
        <div class="location-card"><div class="flag">üáØüáµ</div><h4>Hokkaido</h4><p>Japan</p></div>
        <div class="location-card"><div class="flag">üá¶üá∑</div><h4>Regi√≥n Pampeana</h4><p>Argentina</p></div>
      </div>
      <p style="margin-top:1rem;padding:1rem;background:linear-gradient(135deg,rgba(22,163,74,.1),rgba(255,255,255,.9));border-radius:10px;border-left:4px solid var(--primary-green);" data-i18n="cov_note">
        üí° Flexibilidad total: la App permite dibujar AOIs personalizados (rect√°ngulo/pol√≠gono).
      </p>
    </section>
  </div>

  <!-- Technical -->
  <div class="container">
    <section class="section">
      <h2 class="section-title" data-i18n="tech_title">Tecnolog√≠a de Detecci√≥n Avanzada</h2>
      <p style="margin-bottom:1rem" data-i18n="tech_text">
        Integramos datos HLSS30/Sentinel-2 y t√©cnicas de unmixing para floraciones con precisi√≥n.
      </p>
      <div class="tech-grid">
        <div class="tech-card">
          <h3><span data-i18n="data_sources">Fuentes de Datos</span></h3>
          <p><strong>HLS v2 (HLSS30, 30m)</strong> ¬∑ <span data-i18n="hls_line">armonizado Landsat‚ÄìSentinel</span></p>
          <p><strong>Sentinel-2 SR (10m)</strong> ¬∑ <span data-i18n="s2_line">correcci√≥n atmosf√©rica</span></p>
          <p data-i18n="fallback">Fallback autom√°tico entre sensores</p>
        </div>
        <div class="tech-card">
          <h3><span data-i18n="unmix_title">Unmixing Espectral</span></h3>
          <p data-i18n="unmix_list">6 endmembers: flores (amarillas/rojas/violetas), hojas, suelo, sombra.</p>
        </div>
        <div class="tech-card">
          <h3><span data-i18n="series_title">Series Temporales</span></h3>
          <p data-i18n="series_text1">Agregaci√≥n mensual (medianas robustas) para nubes/outliers.</p>
          <p data-i18n="series_text2">Fenogramas, picos de floraci√≥n y tendencias.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Indices -->
  <div class="container">
    <section class="section">
      <h2 class="section-title" data-i18n="idx_title">√çndices Espectrales</h2>
      <div class="indices-grid">
        <div class="index-box">
          <h4>MRBI</h4>
          <p data-i18n="mrbi_desc">√çndice de floraci√≥n (Red-Edge vs Green) + residual de unmixing</p>
        </div>
        <div class="index-box"><h4>NDVI-RE</h4><p data-i18n="ndvire_desc">√çndice de verdor (Red-Edge)</p></div>
        <div class="index-box"><h4>NDYI</h4><p data-i18n="ndyi_desc">Yellowness (Green vs Blue)</p></div>
        <div class="index-box"><h4>CRI</h4><p data-i18n="cri_desc">Carotenoid Reflectance Index</p></div>
        <div class="index-box"><h4>Bloom Probability</h4><p data-i18n="prob_desc">Probabilidad (0‚Äì100%) y score (0‚Äì1)</p></div>
        <div class="index-box"><h4>Flower Fraction</h4><p data-i18n="ff_desc">% del p√≠xel con flores</p></div>
      </div>
    </section>
  </div>

  <!-- GEE App -->
  <div class="container">
    <section class="gee-section">
      <h2 class="gee-title" data-i18n="gee_title">Google Earth Engine ‚Äì Plataforma Interactiva</h2>
      <p style="text-align:center;margin-bottom:1rem" data-i18n="gee_text">
        Procesamiento en la nube con HLSS30‚ÜíS2, MRBI, unmixing y detecci√≥n mensual de floraciones.
      </p>
      <div class="features-grid">
        <div class="feature-item"><h4 data-i18n="feat_map">Mapa h√≠brido con capas de √≠ndices</h4></div>
        <div class="feature-item"><h4 data-i18n="feat_time">Selector temporal y presets</h4></div>
        <div class="feature-item"><h4 data-i18n="feat_aoi">Dibujo de AOI</h4></div>
        <div class="feature-item"><h4 data-i18n="feat_charts">Gr√°ficos y fenogramas</h4></div>
        <div class="feature-item"><h4 data-i18n="feat_thresholds">Umbrales ajustables</h4></div>
        <div class="feature-item"><h4 data-i18n="feat_autorun">Auto-ejecuci√≥n</h4></div>
      </div>

      <div class="iframe-container">
        <iframe
          src="https://ainabi-dev.projects.earthengine.app/view/demo3"
          style="width:100%;height:700px;border:0;border-radius:10px"
          loading="lazy"
          referrerpolicy="no-referrer"
          allow="geolocation 'self'; fullscreen *">
        </iframe>
        <p style="text-align:center;font-size:.9rem;opacity:.8;margin-top:8px" data-i18n="iframe_caption">
          Fuente: Google Earth Engine App (HLSS30 / Sentinel-2, composites mensuales)
        </p>
      </div>

      <!-- Quick actions for full GEE App -->
      <div class="gee-quick-actions">
        <a id="open-gee-app" class="cta-button" target="_blank" rel="noopener" data-i18n="open_app_btn">
          Abrir App completa (nueva pesta√±a)
        </a>
        <button id="copy-gee-url" class="cta-button" style="background:#2c7fb8" data-i18n="copy_app_btn">
          Copiar enlace del App
        </button>

        <button id="view-gee-code" class="cta-button" data-i18n="view_code_btn" style="background:#0ea5e9">
          Ver c√≥digo (GEE)
        </button>

      </div>
      <p class="gee-quick-note" data-i18n="open_app_note">
        Demo: las funciones de Export (GeoTIFF/CSV) est√°n deshabilitadas por ahora. Se incorporar√°n en una versi√≥n pr√≥xima.
      </p>

      <!-- Demo alert -->
      <div class="demo-alert">
        <strong data-i18n="demo_alert_title">Modo demostraci√≥n:</strong>
        <span data-i18n="demo_alert_text">
          Las exportaciones no est√°n disponibles en esta demo. Est√°n planificadas para futuras versiones p√∫blicas del App.
        </span>
      </div>

      <!-- MRBI Legend -->
      <div style="display:flex;justify-content:center;margin-top:1rem">
        <div class="mrbi-legend">
          <h4 style="color:var(--dark-blue)" data-i18n="legend_title">Escala MRBI</h4>
          <div class="legend-items">
            <div class="legend-item"><div class="legend-color" style="background:blue"></div><span>-0.2</span></div>
            <div class="legend-item"><div class="legend-color" style="background:white;border:1px solid #ccc"></div><span>0.0</span></div>
            <div class="legend-item"><div class="legend-color" style="background:yellow"></div><span>0.2</span></div>
            <div class="legend-item"><div class="legend-color" style="background:orange"></div><span>0.4</span></div>
            <div class="legend-item"><div class="legend-color" style="background:red"></div><span>0.6+</span></div>
          </div>
          <p style="font-size:.9rem;margin-top:.4rem;color:#334155" data-i18n="legend_note">
            Valores &gt; 0.30 indican alta probabilidad de floraci√≥n.
          </p>
        </div>
      </div>
    </section>
  </div>

  <!-- Products / Outputs -->
  <div class="container">
    <section class="section">
      <h2 class="section-title" data-i18n="prod_title">Productos y Visualizaciones</h2>
      <div class="tech-grid">
        <div class="tech-card">
          <h3><span data-i18n="layers_title">Capas del Mapa</span></h3>
          <ul style="margin-left:20px;margin-top:.5rem">
            <li data-i18n="layers_rgb"><strong>RGB natural</strong> (true color)</li>
            <li><strong>MRBI</strong> ‚Äì <span data-i18n="layers_mrbi">√≠ndice de floraci√≥n</span></li>
            <li data-i18n="layers_ff"><strong>Fracci√≥n de flores</strong></li>
            <li><strong>NDVI-RE</strong> ‚Äì <span data-i18n="layers_ndvire">estado de la vegetaci√≥n</span></li>
            <li data-i18n="layers_prob"><strong>Probabilidad de bloom</strong> (0‚Äì100%)</li>
          </ul>
        </div>
        <div class="tech-card">
          <h3><span data-i18n="stats_title">Estad√≠sticas AOI</span></h3>
          <ul style="margin-left:20px;margin-top:.5rem">
            <li data-i18n="stats_items_1">MRBI medio y percentil 90</li>
            <li data-i18n="stats_items_2">Probabilidad de floraci√≥n promedio</li>
            <li data-i18n="stats_items_3">Fracci√≥n de flores media</li>
            <li data-i18n="stats_items_4">√Årea y % del AOI con floraci√≥n</li>
            <li data-i18n="stats_items_5">Alineaci√≥n con temporada esperada</li>
            <li data-i18n="stats_items_6">Detecci√≥n de anomal√≠as (vs. climatolog√≠a)</li>
          </ul>
        </div>
        <div class="tech-card">
          <h3><span data-i18n="time_title">An√°lisis Temporal</span></h3>
          <ul style="margin-left:20px;margin-top:.5rem">
            <li data-i18n="time_items_1">Series mensuales multi-√≠ndice</li>
            <li data-i18n="time_items_2">Fenogramas MRBI vs NDVI-RE</li>
            <li data-i18n="time_items_3">Picos y tendencias de floraci√≥n</li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== User Manual (Accordion) ===== -->
  <div class="container">
    <section class="section" id="manual">
      <h2 class="section-title" data-i18n="man_title">Manual de Usuario</h2>
      <p style="margin-bottom:1rem" data-i18n="man_intro">
        Gu√≠a r√°pida para usar la App de Google Earth Engine (GEE) de BloomWatch.
      </p>

      <div class="accordion">
        <!-- Quick Start -->
        <div class="acc-item">
          <div class="acc-header">
            <span class="acc-title" data-i18n="man_quick_title">Inicio r√°pido</span>
            <span class="acc-icon">‚ñ∂</span>
          </div>
          <div class="acc-content">
            <ol style="margin-left:1.25rem" data-i18n="man_quick_list">
              <li>Eleg√≠ la fuente de datos (HLS recomendado).</li>
              <li>Defin√≠ el rango de fechas o usa 30/90 d√≠as.</li>
              <li>Seleccion√° un AOI o dibuj√° rect√°ngulo/pol√≠gono.</li>
              <li>Ajust√° umbrales (MRBI y fracci√≥n de flores) si quer√©s.</li>
              <li>Hac√© clic en ‚ñ∂Ô∏è Ejecutar an√°lisis.</li>
              <li>Hac√© clic en el mapa para ver el fenograma.</li>
            </ol>
          </div>
        </div>

        <!-- Interface Tour -->
        <div class="acc-item">
          <div class="acc-header">
            <span class="acc-title" data-i18n="man_ui_title">Recorrido de la interfaz</span>
            <span class="acc-icon">‚ñ∂</span>
          </div>
          <div class="acc-content">
            <ul style="margin-left:1.25rem" data-i18n="man_ui_list">
              <li>Mapa h√≠brido + contorno AOI + capas: Color natural, MRBI, Flores, NDVI-RE, Prob. Bloom.</li>
              <li>Panel derecho: idioma, fuente/fechas, AOI, umbrales, ejecutar, limpiar, usar vista, link, exportar.</li>
              <li>Salidas: estad√≠sticas AOI, anomal√≠a vs. climatolog√≠a, serie temporal, fenograma por clic.</li>
            </ul>
          </div>
        </div>

        <!-- Exports & Tips -->
        <div class="acc-item">
          <div class="acc-header">
            <span class="acc-title" data-i18n="man_export_title">Exportaci√≥n y consejos</span>
            <span class="acc-icon">‚ñ∂</span>
          </div>
          <div class="acc-content">
            <ul style="margin-left:1.25rem" data-i18n="man_export_list">
              <li>Export raster: GeoTIFF con MRBI, p_bloom, f_flowers, NDVI-RE.</li>
              <li>Export CSV: serie mensual del AOI.</li>
              <li>Permalink: copia un enlace con par√°metros (fechas, sensor, AOI, umbrales).</li>
              <li><strong data-i18n="demo_inline_note">Nota:</strong> <span data-i18n="demo_inline_text">en esta demo, las exportaciones est√°n deshabilitadas; se habilitar√°n en una versi√≥n futura.</span></li>
              <li>Consejo: empez√° con MRBI 0.20‚Äì0.35 y Flores 0.08‚Äì0.20; ajust√° mirando MRBI+RGB.</li>
            </ul>
          </div>
        </div>

        <!-- Troubleshooting -->
        <div class="acc-item">
          <div class="acc-header">
            <span class="acc-title" data-i18n="man_trouble_title">Soluci√≥n de problemas</span>
            <span class="acc-icon">‚ñ∂</span>
          </div>
          <div class="acc-content">
            <ul style="margin-left:1.25rem" data-i18n="man_trouble_list">
              <li>‚ÄúSin meses v√°lidos‚Äù: prob√° ampliar fechas o usar S2 (fallback autom√°tico).</li>
              <li>‚ÄúComposite √∫nico‚Äù: periodo nublado/escaso; prob√° 90 d√≠as o temporada t√≠pica.</li>
              <li>Fenograma vac√≠o: nubes/m√°scara; clic cercano o usa un parche m√°s grande.</li>
              <li>Series planas: mezcla de 0‚Äì1 y 0‚Äì100; mir√° p_bloom, MRBI y f_flowers por separado.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </div>
  <!-- ===== End User Manual ===== -->

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div style="display:flex;align-items:center;gap:15px;margin-bottom:1rem">
            <img src="768c9991-16d3-4383-8efc-22624499152d.png" alt="Qapy Logo" style="height:40px;filter:drop-shadow(var(--border-glow))" />
            <h4><span data-i18n="foot_sat_t">Sat√©lites & Sensores</span></h4>
          </div>
          <ul>
            <li>NASA HLS (HLSS30 v002)</li>
            <li>ESA Sentinel-2 SR Harmonized</li>
            <li>USGS Landsat 8/9 OLI</li>
            <li>Google Earth Engine</li>
          </ul>
        </div>
        <div class="footer-section">
          <h4><span data-i18n="foot_collab_t">Colaboradores</span></h4>
          <ul>
            <li>NASA Space Apps Challenge</li>
            <li>GLOBE Observer Program</li>
            <li>Google Earth Engine Team</li>
            <li>Research Teams</li>
          </ul>
        </div>
        <div class="footer-section">
          <h4><span data-i18n="foot_res_t">Recursos</span></h4>
          <ul>
            <li data-i18n="foot_docs">Documentaci√≥n t√©cnica</li>
            <li data-i18n="foot_api">API de datos abiertos</li>
            <li data-i18n="foot_tuts">Tutoriales de observaci√≥n</li>
            <li data-i18n="foot_papers">Papers cient√≠ficos</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>¬© 2025 BloomWatch ¬∑ NASA Space Apps Challenge ¬∑ <span data-i18n="foot_love">Hecho con pasi√≥n por el planeta</span></p>
      </div>
    </div>
  </footer>

  <!-- Simple i18n + wiring -->
  <script>
    const dict = {
      es:{

        brand:"BloomWatch Global",
        hero_title:"BloomWatch: <span class='gradient'>Detecci√≥n de floraciones desde el espacio</span>",
        hero_sub:"Monitoreo satelital de floraciones con datos NASA/ESA ¬∑ actualizaci√≥n reciente (30/90 d√≠as)",
        cov_title:"Cobertura Global de Monitoreo",
        cov_text:"Nuestro sistema monitorea floraciones espectaculares en diversos biomas. Con m√∫ltiples sat√©lites y an√°lisis espectral, detectamos y cuantificamos eventos con precisi√≥n.",
        recommended:"Recomendado",
        cov_note:"Flexibilidad total: la App permite dibujar AOIs personalizados (rect√°ngulo/pol√≠gono).",
        tech_title:"Tecnolog√≠a de Detecci√≥n Avanzada",
        tech_text:"Integramos datos HLSS30/Sentinel-2 y t√©cnicas de unmixing para floraciones con precisi√≥n.",
        data_sources:"Fuentes de Datos",
        hls_line:"armonizado Landsat‚ÄìSentinel",
        s2_line:"correcci√≥n atmosf√©rica",
        fallback:"Fallback autom√°tico entre sensores",
        unmix_title:"Unmixing Espectral",
        unmix_list:"6 endmembers: flores (amarillas/rojas/violetas), hojas, suelo, sombra.",
        series_title:"Series Temporales",
        series_text1:"Agregaci√≥n mensual (medianas robustas) para nubes/outliers.",
        series_text2:"Fenogramas, picos de floraci√≥n y tendencias.",
        idx_title:"√çndices Espectrales",
        mrbi_desc:"√çndice de floraci√≥n (Red-Edge vs Green) + residual de unmixing",
        ndvire_desc:"√çndice de verdor (Red-Edge)",
        ndyi_desc:"Yellowness (Green vs Blue)",
        cri_desc:"Carotenoid Reflectance Index",
        prob_desc:"Probabilidad (0‚Äì100%) y score (0‚Äì1)",
        ff_desc:"% del p√≠xel con flores",
        gee_title:"Google Earth Engine ‚Äì Plataforma Interactiva",
        gee_text:"Procesamiento en la nube con HLSS30‚ÜíS2, MRBI, unmixing y detecci√≥n mensual de floraciones.",
        feat_map:"Mapa h√≠brido con capas de √≠ndices",
        feat_time:"Selector temporal y presets",
        feat_aoi:"Dibujo de AOI",
        feat_charts:"Gr√°ficos y fenogramas",
        feat_thresholds:"Umbrales ajustables",
        feat_autorun:"Auto-ejecuci√≥n",
        legend_title:"Escala MRBI",
        legend_note:"Valores > 0.30 indican alta probabilidad de floraci√≥n.",
        iframe_caption:"Fuente: Google Earth Engine App (HLSS30 / Sentinel-2, composites mensuales)",
        prod_title:"Productos y Visualizaciones",
        layers_title:"Capas del Mapa",
        layers_rgb:"RGB natural (true color)",
        layers_mrbi:"√≠ndice de floraci√≥n",
        layers_ff:"Fracci√≥n de flores (% de cobertura floral)",
        layers_ndvire:"estado de la vegetaci√≥n",
        layers_prob:"Probabilidad de bloom (0‚Äì100%)",
        stats_title:"Estad√≠sticas AOI",
        stats_items_1:"MRBI medio y percentil 90",
        stats_items_2:"Probabilidad de floraci√≥n promedio",
        stats_items_3:"Fracci√≥n de flores media",
        stats_items_4:"√Årea y % del AOI con floraci√≥n",
        stats_items_5:"Alineaci√≥n con temporada esperada",
        stats_items_6:"Detecci√≥n de anomal√≠as (vs. climatolog√≠a)",
        time_title:"An√°lisis Temporal",
        time_items_1:"Series mensuales multi-√≠ndice",
        time_items_2:"Fenogramas MRBI vs NDVI-RE",
        time_items_3:"Picos y tendencias de floraci√≥n",
        cta_title:"¬°Unite a la Misi√≥n Global!",
        cta_text:"Sumate a GLOBE Observer y/o iNaturalist para validar las floraciones observadas desde el espacio.",
        cta_btn_globe:"Participar en GLOBE",
        cta_btn_inat:"Ver/Reportar en iNaturalist",
        impact_title:"Impacto del Proyecto",
        impact_intro:"BloomWatch conecta ciencia y gesti√≥n territorial.",
        imp_agri_t:"Agricultura", imp_agri_d:"Optimizaci√≥n de polinizaci√≥n y predicci√≥n de rendimientos.",
        imp_health_t:"Salud p√∫blica", imp_health_d:"Alertas de polen para alergias estacionales.",
        imp_poll_t:"Polinizadores", imp_poll_d:"Mapeo de recursos florales cr√≠ticos.",
        imp_clim_t:"Cambio clim√°tico", imp_clim_d:"Floraciones como bioindicadores.",
        imp_inv_t:"Invasoras", imp_inv_d:"Detecci√≥n temprana por patrones de floraci√≥n.",
        imp_pest_t:"Plagas", imp_pest_d:"Riesgos basados en disponibilidad floral.",
        foot_sat_t:"Sat√©lites & Sensores", foot_collab_t:"Colaboradores", foot_res_t:"Recursos",
        foot_docs:"Documentaci√≥n t√©cnica", foot_api:"API de datos abiertos", foot_tuts:"Tutoriales de observaci√≥n", foot_papers:"Papers cient√≠ficos",
        foot_love:"Hecho con pasi√≥n por el planeta",

        /* ===== Manual ES ===== */
        man_title:"Manual de Usuario",
        man_intro:"Gu√≠a r√°pida para usar la App de Google Earth Engine (GEE) de BloomWatch.",
        man_quick_title:"Inicio r√°pido",
        man_quick_list:`<li>Eleg√≠ la fuente de datos (HLS recomendado).</li>
<li>Defin√≠ el rango de fechas o usa 30/90 d√≠as.</li>
<li>Seleccion√° un AOI o dibuj√° rect√°ngulo/pol√≠gono.</li>
<li>Ajust√° umbrales (MRBI y fracci√≥n de flores) si quer√©s.</li>
<li>Hac√© clic en ‚ñ∂Ô∏è Ejecutar an√°lisis.</li>
<li>Hac√© clic en el mapa para ver el fenograma.</li>`,
        man_ui_title:"Recorrido de la interfaz",
        man_ui_list:`<li>Mapa h√≠brido + contorno AOI + capas: Color natural, MRBI, Flores, NDVI-RE, Prob. Bloom.</li>
<li>Panel derecho: idioma, fuente/fechas, AOI, umbrales, ejecutar, limpiar, usar vista, link, exportar.</li>
<li>Salidas: estad√≠sticas AOI, anomal√≠a vs. climatolog√≠a, serie temporal, fenograma por clic.</li>`,
        man_export_title:"Exportaci√≥n y consejos",
        man_export_list:`<li>Export raster: GeoTIFF con MRBI, p_bloom, f_flowers, NDVI-RE.</li>
<li>Export CSV: serie mensual del AOI.</li>
<li>Permalink: copia un enlace con par√°metros (fechas, sensor, AOI, umbrales).</li>
<li>Consejo: empez√° con MRBI 0.20‚Äì0.35 y Flores 0.08‚Äì0.20; ajust√° mirando MRBI+RGB.</li>`,

        /* ===== Troubleshooting ES ===== */
        man_trouble_title:"Soluci√≥n de problemas",
        man_trouble_list:`<li>‚ÄúSin meses v√°lidos‚Äù: prob√° ampliar fechas o usar S2 (fallback autom√°tico).</li>
<li>‚ÄúComposite √∫nico‚Äù: periodo nublado/escaso; prob√° 90 d√≠as o temporada t√≠pica.</li>
<li>Fenograma vac√≠o: nubes/m√°scara; clic cercano o usa un parche m√°s grande.</li>
<li>Series planas: mezcla de 0‚Äì1 y 0‚Äì100; mir√° p_bloom, MRBI y f_flowers por separado.</li>`,

        /* ===== Quick actions ES ===== */
        open_app_btn:"Abrir App completa (nueva pesta√±a)",
        copy_app_btn:"Copiar enlace del App",
        open_app_note:"Demo: las funciones de Export (GeoTIFF/CSV) est√°n deshabilitadas por ahora. Se incorporar√°n en una versi√≥n pr√≥xima.",
        copied_toast:"¬°Enlace copiado!",
        demo_alert_title:"Modo demostraci√≥n:",
        demo_alert_text:"Las exportaciones no est√°n disponibles en esta demo. Est√°n planificadas para futuras versiones p√∫blicas del App.",
        demo_inline_note:"Nota:",
        demo_inline_text:"en esta demo, las exportaciones est√°n deshabilitadas; se habilitar√°n en una versi√≥n futura.",
        view_code_btn:"Ver c√≥digo (GEE)"
      
      },
      en:{

        brand:"BloomWatch Global",
        hero_title:"BloomWatch: <span class='gradient'>Detecting blooms from space</span>",
        hero_sub:"Satellite monitoring with NASA/ESA data ¬∑ recent updates (30/90 days)",
        cov_title:"Global Monitoring Coverage",
        cov_text:"We monitor spectacular blooms across biomes. With multi-satellite data and spectral analytics we detect and quantify events with precision.",
        recommended:"Recommended",
        cov_note:"Full flexibility: draw custom AOIs (rectangle/polygon) in the App.",
        tech_title:"Advanced Detection Technology",
        tech_text:"We combine HLSS30/Sentinel-2 and spectral unmixing to detect flowering accurately.",
        data_sources:"Data Sources",
        hls_line:"harmonized Landsat‚ÄìSentinel",
        s2_line:"atmospheric correction",
        fallback:"Automatic sensor fallback",
        unmix_title:"Spectral Unmixing",
        unmix_list:"6 endmembers: flowers (yellow/red/violet), green leaves, soil, shadow.",
        series_title:"Time Series",
        series_text1:"Monthly aggregation (robust medians) to handle clouds/outliers.",
        series_text2:"Phenograms, flowering peaks and trends.",
        idx_title:"Spectral Indices",
        mrbi_desc:"Bloom index (Red-Edge vs Green) + unmixing residual",
        ndvire_desc:"Greenness index (Red-Edge)",
        ndyi_desc:"Yellowness (Green vs Blue)",
        cri_desc:"Carotenoid Reflectance Index",
        prob_desc:"Probability (0‚Äì100%) and composite score (0‚Äì1)",
        ff_desc:"% of pixel occupied by flowers",
        gee_title:"Google Earth Engine ‚Äì Interactive Platform",
        gee_text:"Cloud processing with HLSS30‚ÜíS2, MRBI, unmixing, and monthly bloom detection.",
        feat_map:"Hybrid map with index overlays",
        feat_time:"Time presets and range selector",
        feat_aoi:"AOI drawing",
        feat_charts:"Charts & phenograms",
        feat_thresholds:"Adjustable thresholds",
        feat_autorun:"Auto-run",
        legend_title:"MRBI Scale",
        legend_note:"Values > 0.30 indicate high bloom probability.",
        iframe_caption:"Source: Google Earth Engine App (HLSS30 / Sentinel-2, monthly composites)",
        prod_title:"Products & Visualizations",
        layers_title:"Map Layers",
        layers_rgb:"True-color RGB",
        layers_mrbi:"bloom index",
        layers_ff:"Flower fraction (coverage %)",
        layers_ndvire:"vegetation status",
        layers_prob:"Bloom probability (0‚Äì100%)",
        stats_title:"AOI Statistics",
        stats_items_1:"Mean MRBI & 90th percentile",
        stats_items_2:"Average bloom probability",
        stats_items_3:"Mean flower fraction",
        stats_items_4:"Area & % of AOI with bloom",
        stats_items_5:"Alignment with expected season",
        stats_items_6:"Anomaly detection (vs climatology)",
        time_title:"Temporal Analysis",
        time_items_1:"Monthly multi-index series",
        time_items_2:"Phenograms MRBI vs NDVI-RE",
        time_items_3:"Flowering peaks & trends",
        cta_title:"Join the Global Mission!",
        cta_text:"Contribute with GLOBE Observer and iNaturalist to validate satellite bloom maps.",
        cta_btn_globe:"Join GLOBE",
        cta_btn_inat:"View/Report on iNaturalist",
        impact_title:"Project Impact",
        impact_intro:"BloomWatch connects science and on-the-ground decisions.",
        imp_agri_t:"Agriculture", imp_agri_d:"Optimize pollination and yield prediction.",
        imp_health_t:"Public Health", imp_health_d:"Pollen alerts for seasonal allergies.",
        imp_poll_t:"Pollinators", imp_poll_d:"Mapping floral resources.",
        imp_clim_t:"Climate Change", imp_clim_d:"Blooms as bio-indicators.",
        imp_inv_t:"Invasives", imp_inv_d:"Early detection via bloom patterns.",
        imp_pest_t:"Pests", imp_pest_d:"Risk from floral resource dynamics.",
        foot_sat_t:"Satellites & Sensors", foot_collab_t:"Collaborators", foot_res_t:"Resources",
        foot_docs:"Technical documentation", foot_api:"Open data API", foot_tuts:"Observation tutorials", foot_papers:"Scientific papers",
        foot_love:"Built with care for the planet",

        /* ===== Manual EN ===== */
        man_title:"User Manual",
        man_intro:"Quick guide for using the BloomWatch Google Earth Engine (GEE) App.",
        man_quick_title:"Quick Start",
        man_quick_list:`<li>Pick the data source (HLS recommended).</li>
<li>Set the date range or use 30/90-day presets.</li>
<li>Choose an AOI preset or draw a rectangle/polygon.</li>
<li>Optionally tweak thresholds (MRBI and flower fraction).</li>
<li>Click ‚ñ∂Ô∏è Run analysis.</li>
<li>Click the map to see the phenogram.</li>`,
        man_ui_title:"Interface tour",
        man_ui_list:`<li>Hybrid map + AOI outline + layers: Natural Color, MRBI, Flowers, NDVI-RE, Bloom Probability.</li>
<li>Right panel: language, source/dates, AOI, thresholds, run, clear, use view, link, exports.</li>
<li>Outputs: AOI stats, anomaly vs climatology, time series, on-click phenogram.</li>`,
        man_export_title:"Exports & tips",
        man_export_list:`<li>Export raster: GeoTIFF with MRBI, p_bloom, f_flowers, NDVI-RE.</li>
<li>Export CSV: monthly AOI time series.</li>
<li>Permalink: copy a link with parameters (dates, sensor, AOI, thresholds).</li>
<li>Tip: start with MRBI 0.20‚Äì0.35 and Flowers 0.08‚Äì0.20; tune by inspecting MRBI+RGB.</li>`,

        /* ===== Troubleshooting EN ===== */
        man_trouble_title:"Troubleshooting",
        man_trouble_list:`<li>‚ÄúNo valid months‚Äù: extend dates or use S2 (automatic fallback).</li>
<li>‚ÄúSingle composite‚Äù: cloudy/sparse period; try 90 days or seasonal windows.</li>
<li>Empty phenogram: clouds/masks; click nearby or use a larger homogeneous patch.</li>
<li>Flat series: mixing 0‚Äì1 and 0‚Äì100; compare p_bloom, MRBI and f_flowers separately.</li>`,

        /* ===== Quick actions EN ===== */
        open_app_btn:"Open full App (new tab)",
        copy_app_btn:"Copy App link",
        open_app_note:"Demo: Export (GeoTIFF/CSV) features are disabled for now. They will be added in an upcoming version.",
        copied_toast:"Link copied!",
        demo_alert_title:"Demo mode:",
        demo_alert_text:"Exports are not available in this demo. They‚Äôre planned for future public releases of the App.",
        demo_inline_note:"Note:",
        demo_inline_text:"in this demo, exports are disabled; they will be enabled in a future version.",
        view_code_btn:"View code (GEE)"
      
      }
    };

    function setLang(lang){
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        const html = dict[lang][key] || el.innerHTML;
        el.innerHTML = html;
      });
      document.documentElement.lang = lang;
      document.querySelectorAll(".lang-btn").forEach(b=>{
        b.classList.toggle("active", b.dataset.lang === lang);
      });
    }

    document.querySelectorAll(".lang-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> setLang(btn.dataset.lang));
    });

    // Default ES
    setLang('es');

    // Accordion behavior
    document.querySelectorAll('.acc-item').forEach(item=>{
      const header = item.querySelector('.acc-header');
      const content = item.querySelector('.acc-content');
      header.addEventListener('click', ()=>{
        const isOpen = item.classList.contains('open');
        document.querySelectorAll('.acc-item').forEach(i=>{
          i.classList.remove('open');
          const c = i.querySelector('.acc-content');
          c.style.maxHeight = null;
          c.classList.remove('open');
        });
        if(!isOpen){
          item.classList.add('open');
          content.classList.add('open');
          content.style.maxHeight = content.scrollHeight + 'px';
        }
      });
    });

    // Open first accordion by default
    const firstAcc = document.querySelector('.acc-item');
    if(firstAcc){
      firstAcc.classList.add('open');
      const c = firstAcc.querySelector('.acc-content');
      c.classList.add('open');
      c.style.maxHeight = c.scrollHeight + 'px';
    }

    // Link "Open App" to the iframe src and enable "Copy link"
    (function wireGEEActions(){
      const iframe = document.querySelector('.iframe-container iframe');
      const openBtn = document.getElementById('open-gee-app');
      const copyBtn = document.getElementById('copy-gee-url');

      const url = iframe?.getAttribute('src');
      if (url && openBtn){
        openBtn.href = url;
      }

      if (copyBtn){
        copyBtn.addEventListener('click', async ()=>{
          try{
            const link = url || '';
            await navigator.clipboard.writeText(link);
            // mini toast
            const t = document.createElement('div');
            const lang = document.documentElement.lang || 'es';
            t.textContent = (dict[lang]||dict.es).copied_toast || 'Copiado';
            t.style.position='fixed'; t.style.bottom='24px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
            t.style.background='rgba(0,0,0,.8)'; t.style.color='#fff'; t.style.padding='10px 16px';
            t.style.borderRadius='10px'; t.style.zIndex='9999'; t.style.boxShadow='0 10px 30px rgba(0,0,0,.25)';
            document.body.appendChild(t);
            setTimeout(()=> t.remove(), 1200);
          }catch(e){ console.warn('Clipboard error', e); }
        });
      }
    })();
  
// ===== Add handler for "Ver c√≥digo (GEE)" =====


</script>
<script id="gee-source" type="text/plain">
/***************************************
 * BloomWatch ‚Äî Earth Engine App (PRO, one-file)
 * ENGLISH-ONLY VERSION
 * - UI: SplitPanel (map + fixed panel)
 * - Auto-run on load
 * - HLSS30 ‚Üí fallback Sentinel-2 (loose)
 * - Unmix + residual + MRBI + p_bloom
 * - Monthly series (robust, bestEffort, tileScale)
 * - AOI lore + anomaly (MRBI vs. climatology N years)
 * - Export raster/CSV + permalink
 ***************************************/

/* ================== UTIL & DATES ================== */
function pad2(n){ return (n<10 ? '0' : '') + n; }
function fmtDate(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()); }

var NOW = new Date();
var START_DEF = new Date(NOW.getTime() - 90*24*60*60*1000);
var START_DATE = fmtDate(START_DEF);
var END_DATE   = fmtDate(NOW);

var BANDLIST = ['B2','B3','B4','B5','B6','B7','B8','B8A','B11','B12'];
var SUM_SCALE = 200; // reductions & series: fast/robust

function aggGeom(g){ return ee.Geometry(g).simplify(1000); }
function clamp01(img){ return img.max(0).min(1); }
function pctStr(x){ return (x==null || isNaN(x)) ? '‚Äî' : (Number(x)*100).toFixed(1)+'%'; }
function numStr(x, d){ return (x==null || isNaN(x)) ? '‚Äî' : Number(x).toFixed(d||3); }
var MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

/* ============ CONSTANTS & THRESHOLDS ============= */
var CLIMO_BACK_YEARS = 6; // baseline years back
var ANOM_STRONG = 0.15;   // strong anomaly threshold (MRBI)
var ANOM_MOD = 0.08;      // moderate
function shiftYear(dateStr, deltaYears){ return ee.Date(dateStr).advance(deltaYears, 'year').format('YYYY-MM-dd'); }

/* ================== UI LAYOUT ================== */
ui.root.clear();
var map = ui.Map(); map.setOptions('HYBRID');

var rightPanel = ui.Panel({style:{width:'420px', minWidth:'420px', padding:'12px'}});
var split = ui.SplitPanel({ firstPanel: map, secondPanel: rightPanel, orientation: 'horizontal', wipe: false });
ui.root.add(split);

// Title
var titleLabel = ui.Label({ value: 'üåº BloomWatch ‚Äî NASA EO (GEE)', style:{fontSize:'18px', fontWeight:'bold', color:'#16a34a'} });
rightPanel.add(titleLabel);

/* ================== CONTROLS ================== */
rightPanel.add(ui.Label('Data source'));

var sensorSelect = ui.Select({
  items: [
    {label: 'HLS v2 (HLSS30, 30 m) ‚Äî recommended', value: 'HLS'},
    {label: 'Sentinel-2 SR (10 m)',                value: 'S2'}
  ],
  value: 'HLS', style:{stretch:'horizontal', margin:'6px 0'}
});
rightPanel.add(sensorSelect);

rightPanel.add(ui.Label('Date range (YYYY-MM-DD'));

var startBox = ui.Textbox({value: START_DATE, style:{width:'48%'}});
var endBox   = ui.Textbox({value: END_DATE,   style:{width:'48%'}});
rightPanel.add(ui.Panel([startBox, endBox], ui.Panel.Layout.flow('horizontal')));

// Quick date buttons
function qBtn(lbl, fn){ return ui.Button({label: lbl, onClick: fn, style:{margin:'4px 4px 0 0'}}); }
var quickRow = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
quickRow.add(qBtn('üïí Last 30 days', function(){ var e=new Date(), s=new Date(e.getTime()-30*24*60*60*1000); startBox.setValue(fmtDate(s)); endBox.setValue(fmtDate(e)); }));
quickRow.add(qBtn('üïí Last 90 days', function(){ var e=new Date(), s=new Date(e.getTime()-90*24*60*60*1000); startBox.setValue(fmtDate(s)); endBox.setValue(fmtDate(e)); }));
quickRow.add(qBtn('üåº South Aug‚ÄìDec', function(){ var y=new Date().getFullYear(); startBox.setValue(y+'-08-01'); endBox.setValue(y+'-12-31'); }));
rightPanel.add(quickRow);

// AOI presets
var AOI_PRESETS = {
  'Western Australia ‚Äî Mid West (AU) [recommended]': ee.Geometry.Rectangle([114.5,-30.8,117.5,-27.8]),
  'Namaqualand (ZA)':                                 ee.Geometry.Rectangle([16.5,-31.5,19.5,-29.5]),
  'Carrizo Plain (California, US)':                   ee.Geometry.Rectangle([-120.9,34.9,-118.6,36.2]),
  'Castilla-La Mancha (ES)':                          ee.Geometry.Rectangle([-4.9,38.0,-2.8,39.6]),
  'Hokkaido (JP)':                                    ee.Geometry.Rectangle([141.0,42.3,144.0,43.9]),
  'Bah√≠a Blanca (AR)':                                ee.Geometry.Rectangle([-64.0,-40.0,-60.5,-37.6])
};

// AOI lore (short field notes)
var AOI_INFO = {
  'Western Australia ‚Äî Mid West (AU) [recommended]': {
    title: 'Mid West, Western Australia',
    summary: 'Open shrublands/woodlands; famous spring ‚Äúeverlastings‚Äù.',
    months: 'Sep‚ÄìNov (austral spring)',
    drivers: 'Winter rainfall + sandy soils + spring warming.',
    species: 'Everlastings (Asteraceae), Banksia, Grevillea, Hakea.',
    validation: 'Record mass blooms, dominant color, 3 photos (panorama + macro + leaf).'
  },
  'Namaqualand (ZA)': {
    title: 'Namaqualand, South Africa',
    summary: 'Cold coastal desert; ‚Äúflower carpets‚Äù after winter rains.',
    months: 'Aug‚ÄìOct',
    drivers: 'Cold fronts + coastal fog + warming spells.',
    species: 'Dimorphotheca, Arctotis, Felicia.',
    validation: 'Large patches; dominant color; upload to iNaturalist.'
  },
  'Carrizo Plain (California, US)': {
    title: 'Carrizo Plain, California',
    summary: 'Semi-arid plains with superblooms in wet years.',
    months: 'Mar‚ÄìMay',
    drivers: 'Fall/winter rains + mild springs.',
    species: 'Tidy tips, goldfields, phacelia, lupines.',
    validation: 'Tag ‚Äúsuperbloom‚Äù; panorama and macro.'
  },
  'Castilla-La Mancha (ES)': {
    title: 'Castilla-La Mancha, Spain',
    summary: 'Cereal‚Äìscrub‚Äìoak mosaic; spring blooms.',
    months: 'Apr‚ÄìJun',
    drivers: 'Late-winter rains + spring warming.',
    species: 'Poppies (Papaver), Cistus, grasses.',
    validation: 'Field margins and fallows; red/yellow/purple hues.'
  },
  'Hokkaido (JP)': {
    title: 'Hokkaido, Japan',
    summary: 'Cool climate; late peak blooming.',
    months: 'May‚ÄìJul',
    drivers: 'Snowmelt + long photoperiod + mild spells.',
    species: 'Lavender, Nemophila, boreal spp.',
    validation: 'Note phenophase and visible pollinators.'
  },
  'Bah√≠a Blanca (AR)': {
    title: 'Bah√≠a Blanca, Argentina',
    summary: 'Coastal steppe/espinal; subtle, brief blooms.',
    months: 'Oct‚ÄìDec',
    drivers: 'Spring rains + warm pulses + moisture availability.',
    species: 'Yellow composites, native grasses, urban ornamentals.',
    validation: 'Parks and rural verges; photos and dominant color.'
  }
};

// Threshold presets per AOI
var THRESH_PRESETS = {
  'Western Australia ‚Äî Mid West (AU) [recommended]': {mrbi:0.30, flowers:0.15},
  'Namaqualand (ZA)':                                 {mrbi:0.28, flowers:0.12},
  'Carrizo Plain (California, US)':                   {mrbi:0.25, flowers:0.10},
  'Castilla-La Mancha (ES)':                          {mrbi:0.22, flowers:0.08},
  'Hokkaido (JP)':                                    {mrbi:0.26, flowers:0.10},
  'Bah√≠a Blanca (AR)':                                {mrbi:0.20, flowers:0.08}
};

var AOI = AOI_PRESETS['Western Australia ‚Äî Mid West (AU) [recommended]'];

rightPanel.add(ui.Label('AOI (optimized global presets)'));

var aoiDropdown = ui.Select({
  items:Object.keys(AOI_PRESETS),
  value:'Western Australia ‚Äî Mid West (AU) [recommended]',
  onChange:function(k){
    AOI = AOI_PRESETS[k];
    map.centerObject(AOI,7);
    drawAOIOutline();
    var preset = THRESH_PRESETS[k];
    if (preset){ mrbiThr.setValue(preset.mrbi); flowersThr.setValue(preset.flowers); }
    renderLore(k, null, sensorSelect.getValue()==='HLS' ? 'HLSS30' : 'S2');
    refreshSeasonHint();
  }
});
rightPanel.add(aoiDropdown);

// Draw AOI tools
var dt = map.drawingTools();
dt.setShown(true);
dt.setDrawModes(['rectangle','polygon']);

var drawRow = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
drawRow.add(ui.Button({label:'‚úèÔ∏è Rectangle', onClick:function(){ dt.setShape('rectangle'); dt.draw(); }, style:{margin:'4px 8px 0 0'}}));
drawRow.add(ui.Button({label:'üî∫ Polygon',   onClick:function(){ dt.setShape('polygon');   dt.draw(); }, style:{margin:'4px 0 0 0'}}));
rightPanel.add(drawRow);

dt.onDraw(function(geom){
  if (geom){
    AOI = ee.Geometry(geom); map.centerObject(AOI,9); drawAOIOutline();
    renderLore(aoiDropdown.getValue(), null, sensorSelect.getValue()==='HLS' ? 'HLSS30' : 'S2');
  }
});

// Thresholds
rightPanel.add(ui.Label('Alert thresholds'));

var mrbiThr = ui.Slider({min:-0.1,max:0.8,value:0.30,step:0.01,style:{stretch:'horizontal'}});
var flowersThr = ui.Slider({min:0,max:0.60,value:0.15,step:0.01,style:{stretch:'horizontal'}});
rightPanel.add(ui.Panel([ui.Label('MRBI ‚â•'), mrbiThr, ui.Label('  Flowers ‚â•'), flowersThr],
                        ui.Panel.Layout.flow('horizontal')));

// Expected season hint
var seasonHint = ui.Label('', {color:'#6b7280', margin:'4px 0 8px 0'});
rightPanel.add(seasonHint);

function expectedMonthsFromString(txt){
  if (!txt) return null;                 // e.g., "Sep‚ÄìNov (austral spring)"
  var parts = txt.split('(')[0].trim();  // "Sep‚ÄìNov"
  var ranges = parts.split(/[,;]/);
  var set = {};
  function mIdx(s){
    var m = s.trim().substr(0,3).toLowerCase();
    var en = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    return (m in en)? en[m] : null;
  }
  ranges.forEach(function(r){
    r = r.trim(); if (!r) return;
    var mm = r.split('‚Äì');
    if (mm.length===2){
      var a = mIdx(mm[0]), b = mIdx(mm[1]);
      if (a!=null && b!=null){
        for (var i=0;i<12;i++){ var j=(a+i)%12; set[j]=true; if (j===b) break; }
      }
    } else {
      var one = mIdx(r); if (one!=null) set[one]=true;
    }
  });
  var arr = []; for (var k in set){ if (set[k]) arr.push(Number(k)); }
  return arr;
}
function expectedMonthsByHemisphere(centroidLat){
  return (centroidLat < 0) ? [8,9,10,11,0] : [2,3,4,5]; // South: Sep‚ÄìJan; North: Mar‚ÄìJun
}
function expectedMonthsForAOI(aoiKey, aoiGeom){
  var info = AOI_INFO[aoiKey];
  var arr = info && info.months ? expectedMonthsFromString(info.months) : null;
  if (arr && arr.length) return arr;
  var lat = ee.Number(ee.Geometry(aoiGeom).centroid().coordinates().get(1)).getInfo();
  return expectedMonthsByHemisphere(lat);
}
function refreshSeasonHint(){
  var k = aoiDropdown.getValue();
  var info = AOI_INFO[k];
  seasonHint.setValue(info ? ('üóìÔ∏è Expected season: ' + info.months) : '');
}
refreshSeasonHint();

// RUN button
var runBtn = ui.Button({label:'‚ñ∂Ô∏è Run analysis', style:{margin:'8px 0'}});
rightPanel.add(runBtn);

/* ======= Extra tools ======= */
var toolsRow = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
var clearBtn = ui.Button({label:'üßπ Clear drawings', onClick:function(){
  var layers = dt.layers();
  for (var i=layers.length()-1; i>=0; i--) {
    var layer = layers.get(i);
    while(layer.geometries().length()>0){ layer.geometries().remove(layer.geometries().get(0)); }
  }
}, style:{margin:'4px 8px 0 0'}});
var useViewBtn = ui.Button({label:'üó∫Ô∏è Use current view', onClick:function(){
  AOI = map.getBounds(true);
  map.centerObject(AOI, map.getZoom());
  drawAOIOutline();
}, style:{margin:'4px 0 0 0'}});
toolsRow.add(clearBtn); toolsRow.add(useViewBtn);
rightPanel.add(toolsRow);

// Permalink
function buildPermalink(){
  var bbox = ee.Geometry(AOI).bounds().coordinates().flatten().getInfo();
  var params = {
    start: startBox.getValue(),
    end: endBox.getValue(),
    sensor: sensorSelect.getValue(),
    mrbi: mrbiThr.getValue(),
    flowers: flowersThr.getValue(),
    preset: aoiDropdown.getValue(),
    bbox: bbox
  };
  var loc = ui.url.getLocation();
  var url = 'https://' + (loc && loc.get ? loc.get('host') : 'apps.earthengine.google.com') +
            (loc && loc.get ? loc.get('path') : '') + '?state=' + encodeURIComponent(JSON.stringify(params));
  return url;
}
var copyLinkBtn = ui.Button({label:'üîó Copy link', onClick:function(){
  var url = buildPermalink();
  print('üîó Permalink:', url);
  if (ui.clipboard) ui.clipboard().set(url);
}});
rightPanel.add(copyLinkBtn);

// Exports
var exportRasterBtn = ui.Button({
  label: 'üíæ Export raster',
  onClick: function(){
    if (!lastResult){ print('No result yet.'); return; }
    Export.image.toDrive({
      image: ee.Image(lastResult.latest).select(['MRBI','p_bloom','f_flowers','NDVI_RE']),
      description: 'BloomWatch_latest_'+startBox.getValue(),
      region: AOI, scale: 30, maxPixels: 1e13
    });
    print('‚úÖ Raster export started ‚Üí Tasks');
  }
});
var exportCSVBtn = ui.Button({
  label: 'üìä Export time series (CSV)',
  onClick: function(){
    if (!lastResult){ print('No result yet.'); return; }
    var fc = seriesMeanFC(lastResult.seriesOk, AOI, SUM_SCALE);
    Export.table.toDrive({
      collection: fc,
      description: 'BloomWatch_series_'+startBox.getValue(),
      fileFormat: 'CSV'
    });
    print('‚úÖ CSV export started ‚Üí Tasks');
  }
});
rightPanel.add(ui.Panel([exportRasterBtn, exportCSVBtn], ui.Panel.Layout.flow('horizontal')));

/* ============= OUTPUT PANELS ============= */
var statsPanel = ui.Panel({style:{backgroundColor:'#f0fdf4', padding:'8px', margin:'8px 0'}});
var anomalyPanel = ui.Panel({style:{backgroundColor:'#fff7ed', padding:'8px', margin:'8px 0', border:'1px solid #fed7aa'}});
var chartsPanel = ui.Panel();
rightPanel.add(statsPanel);
rightPanel.add(anomalyPanel);
rightPanel.add(chartsPanel);

// Lore
rightPanel.add(ui.Label({value:'‚ÑπÔ∏è About this place', style:{fontWeight:'bold'}}));
var lorePanel = ui.Panel({style:{backgroundColor:'#fff', padding:'8px', margin:'8px 0', border:'1px solid #e5e7eb'}});
rightPanel.add(lorePanel);

/* ============= LORE RENDER ============= */
function renderLore(aoiKey, stats, srcLabel){
  var info = AOI_INFO[aoiKey] || {title:aoiKey, summary:'', months:'‚Äî', drivers:'‚Äî', species:'‚Äî', validation:'‚Äî'};
  lorePanel.clear();
  lorePanel.add(ui.Label(info.title, {fontWeight:'bold'}));
  if (info.summary)   lorePanel.add(ui.Label('Summary: ' + info.summary));
  if (info.months)    lorePanel.add(ui.Label('Expected season: ' + info.months));
  if (info.drivers)   lorePanel.add(ui.Label('Key drivers: ' + info.drivers));
  if (info.species)   lorePanel.add(ui.Label('Typical species: ' + info.species));

  var mrbi   = (stats && stats.MRBI_mean!=null) ? Number(stats.MRBI_mean) : null;
  var ffl    = (stats && stats.f_flowers_mean!=null) ? Number(stats.f_flowers_mean) : null;
  var prob   = (stats && stats.bloom_probability_mean!=null) ? Number(stats.bloom_probability_mean)/100 : null;

  var line   = 'Current status ('+srcLabel+'): ';
  if (mrbi!=null && ffl!=null){
    if (mrbi>0.35 && ffl>0.20)      line += 'Strong bloom signal in regional aggregate.';
    else if (mrbi>0.20 && ffl>0.10) line += 'Moderate blooming, probably patchy.';
    else                            line += 'Weak or absent at this temporal scale.';
  } else {
    line += 'Not enough data yet to interpret.';
  }
  lorePanel.add(ui.Label(line));
  if (prob!=null) lorePanel.add(ui.Label('Composite bloom probability: ' + pctStr(prob)));
  if (info.validation) lorePanel.add(ui.Label('Suggested validation: ' + info.validation));
}

/* ============= AOI OUTLINE & QUICK RGB ============= */
var aoiOutlineLayer;
function drawAOIOutline(){
  if (aoiOutlineLayer) map.layers().remove(aoiOutlineLayer);
  var outline = ee.Image().byte().paint(AOI, 1, 2);
  aoiOutlineLayer = map.addLayer(outline, {palette:'white'}, 'AOI (edge)', true);
}
function quickRGB(start, end){
  var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterDate(start, end).filterBounds(AOI)
    .map(function(img){
      var qa = img.select('QA60');
      var cloud = qa.bitwiseAnd(1<<10).neq(0);
      var cirrus = qa.bitwiseAnd(1<<11).neq(0);
      var mask = cloud.or(cirrus).not();
      return img.updateMask(mask).divide(10000);
    });
  var m = ee.Image(ee.Algorithms.If(s2.size().gt(0), s2.median(),
    ee.Image.constant([0,0,0]).rename(['B4','B3','B2']).float()));
  return m.select(['B4','B3','B2']);
}

/* ============= COLLECTIONS ============= */
function getHLS(start, end){
  function renameHLS(img){
    var from = ['B02','B03','B04','B05','B06','B07','B08','B8A','B11','B12'];
    return img.select(from, BANDLIST).copyProperties(img, ['system:time_start']);
  }
  return ee.ImageCollection('NASA/HLS/HLSS30/v002')
    .filterDate(start, end).filterBounds(AOI).map(renameHLS);
}
function getS2Loose(start, end){
  function prep(img){ return img.divide(10000).select(BANDLIST).copyProperties(img,['system:time_start']); }
  return ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
    .filterDate(start, end).filterBounds(AOI).map(prep);
}

// Climatology (baseline with S2 loose)
function buildClimatologyComposite(startStr, endStr, yearsBack){
  var ranges = ee.List.sequence(1, yearsBack).map(function(k){
    k = ee.Number(k);
    return ee.Dictionary({ s: shiftYear(startStr, -k), e: shiftYear(endStr, -k) });
  });

  var empty = ee.ImageCollection([]);
  var ic = ee.ImageCollection(
    ee.List(ranges).iterate(function(rec, acc){
      rec = ee.Dictionary(rec);
      var s = ee.String(rec.get('s'));
      var e = ee.String(rec.get('e'));
      var icPart = getS2Loose(s, e);
      return ee.ImageCollection(acc).merge(icPart);
    }, empty)
  );

  return ee.Image(ee.Algorithms.If(ic.size().gt(0), ic.median(), ee.Image()));
}

/* ============= ENDMEMBERS & INDICES ============= */
var ENDM_LIST = [
  [0.08,0.12,0.18,0.22,0.35,0.45,0.50,0.48,0.25,0.15], # yellow flower
  [0.06,0.09,0.22,0.26,0.38,0.46,0.49,0.47,0.24,0.16], # red flower
  [0.05,0.08,0.12,0.20,0.34,0.44,0.48,0.46,0.23,0.15], # violet flower
  [0.04,0.08,0.05,0.12,0.28,0.42,0.58,0.56,0.30,0.18], # green leaves
  [0.12,0.16,0.20,0.24,0.28,0.32,0.35,0.34,0.38,0.42], # soil
  [0.02,0.02,0.01,0.01,0.01,0.01,0.01,0.01,0.01,0.01]  # shadow
];
var ENDM_NAMES = ['f_yellow','f_red','f_violet','f_leaves','f_soil','f_shadow'];

function spectralUnmixing(img){
  var fractions = img.select(BANDLIST).unmix(ENDM_LIST, false, true).rename(ENDM_NAMES);
  var M = ee.Array(ENDM_LIST).transpose(); # 10x6
  var fArr = fractions.toArray().toArray(1); # 6x1
  var modeled = ee.Image(M).matrixMultiply(fArr).arrayProject([0]).arrayFlatten([BANDLIST]);
  var resid = img.select(BANDLIST).subtract(modeled);
  var residual_mag = resid.pow(2).reduce(ee.Reducer.mean()).sqrt().rename('residual');
  return img.addBands(fractions).addBands(residual_mag);
}

function addIndices(img){
  var MRBI = img.expression('((RE2 - G) / (RE2 + G)) * (1 + R)', {
    RE2: img.select('B6'), G: img.select('B3'), R: img.select('residual')
  }).rename('MRBI');
  var NDVI_RE = img.normalizedDifference(['B8','B5']).rename('NDVI_RE');
  var NDYI    = img.normalizedDifference(['B3','B2']).rename('NDYI');
  var CRI     = img.expression('(1/B2) - (1/B6)', {B2: img.select('B2'), B6: img.select('B6')}).rename('CRI');
  var fFlowers  = img.select(['f_yellow','f_red','f_violet']).reduce(ee.Reducer.sum()).rename('f_flowers');
  var bloomProb = fFlowers.divide(fFlowers.add(img.select('f_leaves')).add(1e-6)).multiply(100).rename('bloom_probability');
  var p_bloom = clamp01(
    img.expression('(MRBI + 0.2) / 0.8', {MRBI: MRBI}).multiply(0.4)
      .add(img.expression('(NDYI + 0.1) / 0.6', {NDYI: NDYI}).multiply(0.2))
      .add(bloomProb.divide(100).multiply(0.4))
  ).rename('p_bloom');
  return img.addBands([MRBI, NDVI_RE, NDYI, CRI, fFlowers, bloomProb, p_bloom]);
}

/* ============= MONTHLY SERIES & REDUCTIONS ============= */
function monthSeries(ic, start, end){
  var s = ee.Date(start), e = ee.Date(end);
  var months = e.difference(s, 'month').floor();
  var idx = ee.List.sequence(0, months);
  return ee.ImageCollection(idx.map(function(i){
    var mStart = s.advance(i, 'month'), mEnd = mStart.advance(1,'month');
    var set = ic.filterDate(mStart, mEnd);
    var img = ee.Algorithms.If(set.size().gt(0),
      set.median().set('system:time_start', mStart.millis()),
      ee.Image().set('system:time_start', mStart.millis()));
    return img;
  }));
}

// Ensure non-empty by requiring MRBI band
function ensureNonEmpty(icProcessed, start, end){
  var icOk = icProcessed.filter(ee.Filter.listContains('system:band_names', 'MRBI'));
  return ee.ImageCollection(ee.Algorithms.If(icOk.size().gt(0),
    icOk,
    ee.ImageCollection([icProcessed.reduce(ee.Reducer.median())
      .set('system:time_start', ee.Date(end).millis())])
  ));
}

// AOI means per image (mask AND across selected bands)
function seriesMeanFC(ic, region, scale){
  var R = aggGeom(region);
  var wanted = ee.List(['MRBI','NDVI_RE','bloom_probability','f_flowers','p_bloom']);

  var col = ic.map(function(img){
    img = ee.Image(img);

    var present = img.bandNames();
    var keep = wanted.map(function(b){
      b = ee.String(b);
      return ee.Algorithms.If(present.contains(b), b, null);
    }).removeAll([null]);

    var hasAny = ee.Number(ee.List(keep).size()).gt(0);
    var dateProp = ee.Date(img.get('system:time_start'));

    return ee.Algorithms.If(hasAny, (function(){
      var sel = img.select(keep);
      var maskRef = sel.mask().reduce(ee.Reducer.min()); // AND of masks
      var toReduce = sel.updateMask(maskRef);

      var stats = toReduce.reduceRegion({
        reducer: ee.Reducer.mean(),
        geometry: R,
        scale: scale,
        bestEffort: true,
        maxPixels: 5e13,
        tileScale: 2
      });
      return ee.Feature(null, stats).set('date', dateProp);
    })(), ee.Feature(null, {}).set('date', dateProp));
  });

  return ee.FeatureCollection(col);
}

// Bloom area & percent
function bloomAreaStats(img, region, mrbiMin, ffracMin, scale){
  var regionS = aggGeom(region);
  var bloomMask = img.select('MRBI').gte(mrbiMin).and(img.select('f_flowers').gte(ffracMin));
  var ones = ee.Image.pixelArea().updateMask(bloomMask);
  var areaBloom = ones.reduceRegion({
    reducer: ee.Reducer.sum(), geometry: regionS, scale: scale, bestEffort: true, maxPixels: 5e13, tileScale: 2
  }).get('area');
  var areaTotal = ee.Image.pixelArea().reduceRegion({
    reducer: ee.Reducer.sum(), geometry: regionS, scale: scale, bestEffort: true, maxPixels: 5e13, tileScale: 2
  }).get('area');
  return ee.Dictionary({ areaBloom: areaBloom, areaTotal: areaTotal });
}
function km2(m2){ return (m2==null)? null : (Number(m2)/1e6); }

// Monthly means & alignment
function monthlyMeansByAOI(ic, region, scale){
  var R = aggGeom(region);
  var byMonth = ee.List.sequence(0,11).map(function(m){
    m = ee.Number(m);
    var subset = ic.filter(ee.Filter.calendarRange(m, m, 'month'));
    var mImg = ee.Image(subset.mean());
    var val = mImg.select('MRBI').reduceRegion({
      reducer: ee.Reducer.mean(), geometry: R, scale: scale, bestEffort:true, maxPixels:5e13, tileScale:2
    }).get('MRBI');
    return ee.Dictionary({month: m, mrbi: val});
  });
  return ee.List(byMonth);
}

function alignmentScore(ic, region, scale, expectedMonths){
  var R = aggGeom(region);
  var means = monthlyMeansByAOI(ic, R, scale);
  var vals = ee.List(means.map(function(d){ return ee.Dictionary(d).get('mrbi'); }));
  var valsSorted = vals.sort();
  var pIndex = ee.Number(valsSorted.size()).multiply(0.6).floor();
  var p60 = ee.Number(ee.Algorithms.If(valsSorted.size().gt(0), valsSorted.get(pIndex), 0));
  var expList = ee.List(expectedMonths);
  var feats = ee.FeatureCollection(means.map(function(d){
    d = ee.Dictionary(d);
    var m = ee.Number(d.get('month'));
    var v = ee.Number(d.get('mrbi'));
    var ok = ee.Algorithms.If(v, ee.Number(v).gte(p60), false);
    var exp = expList.contains(m);
    return ee.Feature(null, {month:m, mrbi:v, ok: ok, expected: exp});
  }));
  return feats.filter(ee.Filter.eq('expected', true)).aggregate_sum('ok');
}

/* ============= ANOMALY ============= */
function explainDrivers(sign){
  return (sign > 0)
    ? 'Possible drivers: above-average rainfall, mild temperatures, moist soils, good radiation. Local management (irrigation/ornamentals) may amplify.'
    : 'Possible drivers: water deficit, heat/cold waves at key moments, persistent cloudiness (masking blooms), herbivory, or phenological shift.';
}
function evaluateAnomaly(startStr, endStr, currentStats, srcLabel){
  anomalyPanel.clear();
  anomalyPanel.add(ui.Label({value:'üîé Anomaly assessment', style:{fontWeight:'bold'}}));
  if (!currentStats || currentStats.MRBI_mean === undefined){
    anomalyPanel.add(ui.Label('Not enough data yet to estimate anomaly.'));
    return;
  }
  var climoComposite = buildClimatologyComposite(startStr, endStr, CLIMO_BACK_YEARS);
  var climoProcessed = ee.Algorithms.If(
    ee.Algorithms.IsEqual(climoComposite.bandNames().size(), 0), null,
    addIndices(spectralUnmixing(ee.Image(climoComposite)))
  );
  ee.Algorithms.If(climoProcessed, ee.Image(climoProcessed), null);
  var statsClimo = ee.Algorithms.If(climoProcessed,
    ee.Image(climoProcessed).select(['MRBI','f_flowers']).reduceRegion({
      reducer: ee.Reducer.mean(), geometry: aggGeom(AOI), scale: SUM_SCALE, bestEffort: true, maxPixels: 5e13, tileScale: 2
    }), null);

  ee.Dictionary(statsClimo).evaluate(function(base){
    if (!base){
      anomalyPanel.add(ui.Label('Could not build a baseline (climatology) for this AOI/date range.'));
      anomalyPanel.add(ui.Label('Tip: widen the date range (e.g., 90 days) or use a slightly larger AOI.'));
      return;
    }
    var nowMRBI = Number(currentStats.MRBI_mean || 0);
    var baseMRBI = Number(base.MRBI_mean || 0);
    var delta = nowMRBI - baseMRBI;
    var absDelta = Math.abs(delta);
    var level = (absDelta >= ANOM_STRONG) ? 'Strong' : (absDelta >= ANOM_MOD ? 'Moderate' : 'Low/Normal');
    var color = (absDelta >= ANOM_STRONG) ? '#b91c1c' : (absDelta >= ANOM_MOD ? '#ca8a04' : '#16a34a');
    var line =
      'Anomaly ' + level + ' in MRBI ('+srcLabel+'): Œî=' + (delta>=0?'+':'') + delta.toFixed(3)
      + ' (current '+ nowMRBI.toFixed(3) + ' vs. climate ' + baseMRBI.toFixed(3) + ').';
    anomalyPanel.add(ui.Label({value: line, style:{color: color, fontWeight:'bold'}}));
    anomalyPanel.add(ui.Label(explainDrivers(delta)));
    anomalyPanel.add(ui.Label('Note: Remote signal. Validate in the field (GLOBE/iNaturalist) and consider clouds, sun angle, and land-use mosaics.', {color:'#6b7280'}));

    if (lastResult){
      var seriesForChart = lastResult.seriesOk.sort('system:time_start', false).limit(12);
      var fcNow = seriesMeanFC(seriesForChart.select(['MRBI']), AOI, SUM_SCALE).map(function(f){ return ee.Feature(f).set('group','Current'); });
      var dates = fcNow.aggregate_array('date');
      var baseMR = baseMRBI;
      var baseFC = ee.FeatureCollection(dates.map(function(d){
        return ee.Feature(null, {date: d, MRBI: baseMR, group: 'Climatology'});
      }));
      var ch = ui.Chart.feature.groups({
        features: fcNow.merge(baseFC),
        xProperty: 'date',
        yProperties: ['MRBI'],
        seriesProperty: 'group'
      }).setOptions({title:'MRBI: Current vs Climatology', lineWidth:2});
      anomalyPanel.add(ch);
    }
  });
}

/* ============= PIPELINE & VISUALIZATION ============= */
function buildPipeline(source, start, end){
  var baseIC = (source === 'HLS') ? getHLS(start, end) : getS2Loose(start, end);
  var monthly = monthSeries(baseIC, start, end);
  var processedMonthly = ee.ImageCollection(monthly.map(function(im){
    var img = ee.Image(im);
    return ee.Algorithms.If(img.bandNames().size().gt(0), addIndices(spectralUnmixing(img)), img);
  }));
  var seriesOk = ensureNonEmpty(processedMonthly, start, end);
  var latest = seriesOk.sort('system:time_start', false).first();
  return {seriesOk: seriesOk, latest: latest};
}

var phenogHint; // ref to label
function visualize(latest, seriesOk, srcLabel){
  map.layers().reset([]); map.setOptions('HYBRID'); map.centerObject(AOI, 7); drawAOIOutline();

  var baseRGB = quickRGB(startBox.getValue(), endBox.getValue());
  map.addLayer(baseRGB, {min:0, max:0.3, gamma:1.4}, 'S2 Quick RGB (base)', true);

  var hasBands = latest.bandNames().size().gt(0);
  var rgb = ee.Image(ee.Algorithms.If(hasBands, latest, ee.Image.constant([0,0,0]).rename(['B4','B3','B2']).float()));
  map.addLayer(rgb, {bands:['B4','B3','B2'], min:0, max:0.3, gamma:1.4}, 'Natural Color ('+srcLabel+')', true);

  map.addLayer(latest.select('MRBI'), {min:-0.2,max:0.6, palette:['blue','white','yellow','orange','red']}, 'MRBI', true);
  map.addLayer(latest.select('f_flowers'), {min:0,max:0.5, palette:['000000','ffff00','ff6600']}, 'Flower fraction', false);
  map.addLayer(latest.select('NDVI_RE'), {min:0,max:0.8, palette:['red','yellow','green']}, 'NDVI-RE', false);
  map.addLayer(latest.select('p_bloom'), {min:0,max:1, palette:['000004','2c7fb8','7fcdbb','c7e9b4','ffffe5']}, 'Bloom Prob.', false);

  latest.select(['MRBI','bloom_probability','f_flowers','residual']).reduceRegion({
    reducer: ee.Reducer.mean().combine({reducer2: ee.Reducer.percentile([90]), sharedInputs:true}),
    geometry: aggGeom(AOI), scale: SUM_SCALE, bestEffort:true, maxPixels:5e13, tileScale: 2
  }).evaluate(function(s){
    s = s || {};
    statsPanel.clear();
    statsPanel.add(ui.Label({value:'üìà AOI Statistics ('+srcLabel+')', style:{fontWeight:'bold'}}));
    statsPanel.add(ui.Label('Mean MRBI: ' + numStr(s.MRBI_mean)));
    statsPanel.add(ui.Label('Mean bloom probability: ' + numStr(s.bloom_probability_mean,1) + '%'));
    statsPanel.add(ui.Label('Mean flower fraction: ' + pctStr(s.f_flowers_mean)));
    statsPanel.add(ui.Label('MRBI p90: ' + numStr(s.MRBI_p90)));

    var thMrbi = mrbiThr.getValue();
    var thFlo  = flowersThr.getValue();
    bloomAreaStats(latest, AOI, thMrbi, thFlo, SUM_SCALE).evaluate(function(a){
      var aB = km2(a && a.areaBloom); var aT = km2(a && a.areaTotal);
      var perc = (aB && aT) ? (100*aB/aT) : null;
      var line = 'Bloom area (‚â•MRBI '+thMrbi.toFixed(2)+', flowers ‚â•'+thFlo.toFixed(2)+'): '
                 + (aB? aB.toFixed(1)+' km¬≤':'‚Äî') + (perc!=null ? (' ('+perc.toFixed(1)+'% of AOI)') : '');
      statsPanel.add(ui.Label(line));
    });

    var expMonths = expectedMonthsForAOI(aoiDropdown.getValue(), AOI);
    var seriesForChartEval = seriesOk.sort('system:time_start', false).limit(12);
    var means = monthlyMeansByAOI(seriesForChartEval, AOI, SUM_SCALE);
    means.evaluate(function(list){
      var peak = {month:null, mrbi:-1e9};
      (list||[]).forEach(function(d){ if (d.mrbi!=null && Number(d.mrbi) > peak.mrbi){ peak={month:d.month, mrbi:Number(d.mrbi)}; }});
      var peakTxt = (peak.month!=null) ? (MONTH_NAMES[peak.month]+' ('+peak.mrbi.toFixed(3)+')') : '‚Äî';
      statsPanel.add(ui.Label('Peak month (latest data): ' + peakTxt));

      alignmentScore(seriesForChartEval, AOI, SUM_SCALE, expMonths).evaluate(function(sc){
        var score = Number(sc||0);
        var denom = expMonths.length || 1;
        var align = Math.min(100, Math.max(0, (score/denom)*100));
        var tag = (align>=70)? 'high' : (align>=40 ? 'medium' : 'low');
        statsPanel.add(ui.Label('Alignment with expected season: ' + align.toFixed(0) + '% ('+tag+')'));

        var ok = (Number(s.MRBI_mean || 0) > thMrbi) && (Number(s.f_flowers_mean || 0) > thFlo);
        statsPanel.add(ui.Label({value: ok ? '‚úÖ Significant bloom' : '‚ùå No strong bloom',
                                 style:{color: ok ? '#16a34a' : '#dc2626', fontWeight:'bold'}}));
      });
    });

    renderLore(aoiDropdown.getValue(), s, srcLabel);
    evaluateAnomaly(startBox.getValue(), endBox.getValue(), s, srcLabel);
  });

  // --- AOI monthly series (12 samples), dynamic Y properties ---
  chartsPanel.clear();
  var seriesForChart = seriesOk.sort('system:time_start', false).limit(12);
  var fcAOI_raw = seriesMeanFC(seriesForChart, AOI, SUM_SCALE);

  var anyValidFilter = ee.Filter.or(
    ee.Filter.notNull(['MRBI']),
    ee.Filter.notNull(['NDVI_RE']),
    ee.Filter.notNull(['bloom_probability']),
    ee.Filter.notNull(['f_flowers']),
    ee.Filter.notNull(['p_bloom'])
  );
  var fcAOI = ee.FeatureCollection(fcAOI_raw.filter(anyValidFilter));

  var yCandidates = ee.List(['MRBI','NDVI_RE','bloom_probability','f_flowers','p_bloom']);
  var yKeep = ee.List(yCandidates.map(function(p){
    p = ee.String(p);
    var n = fcAOI.filter(ee.Filter.notNull([p])).size();
    return ee.Algorithms.If(n.gt(0), p, null);
  })).removeAll([null]);

  yKeep.evaluate(function(ys){
    if (!ys || ys.length === 0){
      chartsPanel.add(ui.Label('No valid monthly data to plot for this AOI/date range.'));
      return;
    }
    var seriesTitle = 'Monthly time series ('+srcLabel+')';
    var seriesChart = ui.Chart.feature.byFeature({
      features: fcAOI, xProperty:'date', yProperties: ys
    }).setOptions({title: seriesTitle, lineWidth: 2});
    chartsPanel.add(seriesChart);
  });

  // Phenogram on click
  var ph = ui.Label('üìç Click map for phenogram (MRBI vs NDVI_RE)');
  chartsPanel.add(ph); phenogHint = ph;
  var pointPanel = ui.Panel(); chartsPanel.add(pointPanel);

  map.onClick(function(coords){
    pointPanel.clear();

    var buf = ee.Number(SUM_SCALE).multiply(3); // ~600 m if SUM_SCALE=200
    var pt = ee.Geometry.Point([coords.lon, coords.lat]).buffer(buf);

    var seriesForPt = seriesOk.sort('system:time_start', false).limit(12);
    var fcPtRaw = seriesMeanFC(seriesForPt.select(['MRBI','NDVI_RE']), pt, SUM_SCALE);
    var fcPt = ee.FeatureCollection(fcPtRaw.filter(ee.Filter.notNull(['MRBI','NDVI_RE'])));

    fcPt.size().evaluate(function(n){
      if (!n || n === 0){
        pointPanel.add(ui.Label('üìç No valid data at this point (cloud/mask). Try clicking nearby or enlarging the area.'));
        return;
      }
      var chart = ui.Chart.feature.byFeature({
        features: fcPt,
        xProperty: 'date',
        yProperties: ['MRBI','NDVI_RE']
      }).setOptions({title:'Phenogram (MRBI vs NDVI_RE)', lineWidth:2});
      pointPanel.add(chart);
    });
  });
}

/* ============= RUN with fallback ============= */
var lastResult = null;
function buildAndVisualize(){
  var start = startBox.getValue(), end = endBox.getValue(), src = sensorSelect.getValue();
  var primary = buildPipeline(src, start, end);
  primary.seriesOk.size().evaluate(function(n){
    if (n && n > 0){
      var latest = primary.seriesOk.sort('system:time_start', false).first();
      visualize(latest, primary.seriesOk, (src === 'HLS' ? 'HLSS30 monthly' : 'S2 monthly'));
      lastResult = {latest: latest, seriesOk: primary.seriesOk, start:start, end:end, src:src};
    } else {
      print('‚õÖ No valid months in '+src+' ‚Äî retrying with Sentinel-2 monthly (loose).');
      var fb = buildPipeline('S2', start, end);
      fb.seriesOk.size().evaluate(function(m){
        if (m && m > 0){
          var latest2 = fb.seriesOk.sort('system:time_start', false).first();
          visualize(latest2, fb.seriesOk, 'S2 monthly (fallback)');
          lastResult = {latest: latest2, seriesOk: fb.seriesOk, start:start, end:end, src:'S2'};
        } else {
          print('‚ùå No valid months either. Showing single-period composite.');
          var composite = getS2Loose(start, end).median();
          var processed = addIndices(spectralUnmixing(composite)).set('system:time_start', ee.Date(end).millis());
          var oneIC = ee.ImageCollection([processed]);
          visualize(processed, oneIC, 'S2 single composite');
          lastResult = {latest: processed, seriesOk: oneIC, start:start, end:end, src:'S2'};
        }
      });
    }
  });
}
runBtn.onClick(buildAndVisualize);

/* ============= LEGENDS ============= */
var legend = ui.Panel({style:{position:'top-right', padding:'8px', backgroundColor:'rgba(255,255,255,0.9)'}});
var legendTitleMRBI = ui.Label('MRBI', {fontWeight:'bold'});
legend.add(legendTitleMRBI);
[
  {c:'blue',   t:'-0.2'}, {c:'white', t:'0.0'},
  {c:'yellow', t:'0.2'},  {c:'orange',t:'0.4'},
  {c:'red',    t:'0.6+'}
].forEach(function(it){
  var row = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
  row.add(ui.Label('', {backgroundColor: it.c, padding:'8px', margin:'2px', width:'16px'}));
  row.add(ui.Label(it.t, {margin:'4px 0 0 6px'}));
  legend.add(row);
});
map.add(legend);

// Bloom Probability legend
var legendPB = ui.Panel({style:{position:'top-right', padding:'8px', backgroundColor:'rgba(255,255,255,0.9)', margin:'8px 0 0 0'}});
var legendTitlePB   = ui.Label('Bloom Prob.', {fontWeight:'bold'});
legendPB.add(legendTitlePB);
[
  {c:'#000004', t:'0.00'},
  {c:'#2c7fb8', t:'0.25'},
  {c:'#7fcdbb', t:'0.50'},
  {c:'#c7e9b4', t:'0.75'},
  {c:'#ffffe5', t:'1.00'}
].forEach(function(it){
  var row2 = ui.Panel({layout: ui.Panel.Layout.flow('horizontal')});
  row2.add(ui.Label('', {backgroundColor: it.c, padding:'8px', margin:'2px', width:'16px'}));
  row2.add(ui.Label(it.t, {margin:'4px 0 0 6px'}));
  legendPB.add(row2);
});
map.add(legendPB);

/* ============= INIT (auto-run) ============= */
print('üåº BloomWatch ‚Äî App ready for demo (iframe). Loading‚Ä¶');
map.centerObject(AOI, 7);
drawAOIOutline();
map.addLayer(quickRGB(START_DATE, END_DATE), {min:0, max:0.3, gamma:1.4}, 'S2 Quick RGB (base)', true);

// Initial lore & season hint
renderLore(aoiDropdown.getValue(), null, sensorSelect.getValue()==='HLS' ? 'HLSS30' : 'S2');
refreshSeasonHint();

// Run pipeline at load
buildAndVisualize();
</script>

<script>
// ===== Add handler for "Ver c√≥digo (GEE)" / "View code (GEE)"
(function addViewCodeButton(){
  const btn = document.getElementById('view-gee-code');
  if(!btn) return;
  btn.addEventListener('click', ()=>{
    try{
      const el = document.getElementById('gee-source');
      const code = el ? el.textContent : '// code not found\n';
      const blob = new Blob([code], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank', 'noopener');
      if(!w){ alert(document.documentElement.lang==='en' ? 'Please allow pop-ups to view the code.' : 'Habilit√° ventanas emergentes para ver el c√≥digo.'); }
      setTimeout(()=> URL.revokeObjectURL(url), 120000);
    }catch(e){
      alert((document.documentElement.lang==='en'?'Could not open code: ':'No se pudo abrir el c√≥digo: ') + e.message);
    }
  });
})();
</script>

</body>
</html>
